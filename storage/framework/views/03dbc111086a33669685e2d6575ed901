<?php $__env->startSection('css'); ?>
<link href="<?php echo e(url('css/forum/styles.css')); ?>" rel="stylesheet">
<?php $__env->stopSection(); ?>

<?php $__env->startSection('header-top'); ?>
<?php echo $__env->make('public.layouts.header.header-top', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>
<?php $__env->startSection('header-middle'); ?>
<?php echo $__env->make('public.layouts.header.header-middle', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>

<?php $__env->startSection('content'); ?>

<!-- Main -->
<div class="container main" style="min-height: 500px;">

    <div class="row">
        <div class="col-md-8 col-md-push-2 news-show">	
            <div class="news-showtitle mt10">
                <strong class="cat-name">
                    <?php $link_cat = url('course/learning') . "/" . $result['course_id']; ?>
                    <a href="<?php echo e($link_cat); ?>"><?php echo e($result['course_name']); ?></a>
                </strong>
                <h1>
                    <p><?php echo e($result['subject']); ?> </p>
                </h1>
                <?php if($result['isEdit']): ?>
                <div class="dropdown" style="float: right">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-chevron-down" style="font-size: 10px"></span></a>
                    <ul class="dropdown-menu">
                        <?php
                        $editLink = $_SERVER['REQUEST_URI'] . '/edit';
                        $deleteLink = $_SERVER['REQUEST_URI'] . '/delete';
                        ?>
                        <li><a href="<?php echo e($editLink); ?>">Edit... </a></li>
                        <li><a href="<?php echo e($deleteLink); ?>">Delete</a></li>
                    </ul>
                </div>
                <?php endif; ?>
                <div class="clearfix">
                    <div class="note fl">
                        <span class="glyphicon glyphicon-user" style="size: 15px;"></span><?php echo e($result['user']); ?> | <?php echo e($result['date']); ?>

                    </div>
                </div>
            </div>

            <div class="content clearfix">
                <div id="ContentDetail">
                    <?php echo $result['content']; ?>

                </div>
            </div>

            <div id="TotalAssessment">
                <!--Ming Comment-->

                <div class="comentvietid">
                    <?php if(isset($result['cuName'])): ?>
                    <div class="panel-body form-comment">
                        <div class = "row" id = "form_post_comment" >
                            <div><img src = "<?php echo e(url(\App\Image::where('user_id', '=', Auth::user()->id)->get()->first()->path)); ?>" width="48px" height="48px"/></div>
                            <div class="text-box">
                                <textarea style="height: 48px;" id="txtComment" placeholder="write a comment..."></textarea>
                            </div>
                            <input type="hidden" id = "idTopic" value = "<?php echo e($result['idTopic']); ?>"/>
                        </div>
                        <div class = "row send-box p-lr">
                            <input class="btn btn-primary" type="button" id ="submitComment" value="Gửi bình luận" />
                        </div>
                    </div>
                    <?php endif; ?>

                    <div class="border-nobottom"></div>
                    <div class="bar">
                        <?php echo e($result['repCount']); ?> Bình luận
                        <input type="hidden" id = "repCount" value = "<?php echo e($result['repCount']); ?>"/>
                    </div>

                    <div class=" row col-md-12" data-example-id="default-media"> 
                        <?php foreach($result['replies'] as $item): ?>
                        <div class="media"> 
                            <div class="media-left"> 
                                <a href="#"> <img data-holder-rendered="true" src="<?php echo e(url($item->link_img)); ?>" style="width: 48px; height: 48px;" class="media-object" data-src="holder.js/64x64" alt="64x64"> </a> 
                            </div> 
                            <div class="media-body">
                                <h4 class="media-heading  <?php echo e($item->isEdit); ?>" id = "cm-<?php echo e($item->id); ?>"><?php echo e($item->rep_by); ?> <span>·</span> <?php echo e($item->rep_date); ?></h4>
                                <p><?php echo $item->rep_content; ?></p>
                                <div class = "co-action" style="margin-top: 5px;">
                                    <a href = "#" class = "reply-comment" id = "<?php echo e($item->id); ?>" style="color: blue; font-size: 12px">Reply</a>
                                </div>
                                <?php if($item->subReply->count() >0): ?>
                                <?php foreach($item->subReply as $sub): ?>
                                <div class="media"> 
                                    <div class="media-left">
                                        <a href="#"> <img data-holder-rendered="true" src="<?php echo e(url(\App\Image::where('user_id', '=', $sub->rep_by)->get()->first()->path)); ?>" style="width: 32px; height: 32px;" class="media-object" alt="48x48"> 
                                        </a> 
                                    </div>
                                    <div class="media-body"> 
                                        <h4 class="media-heading <?php echo e((Auth::check() && Auth::user()->id == $sub->rep_by) ? "edit" : ""); ?>" id = "cm-<?php echo e($sub->id); ?>"><?php echo e(\App\User::find($sub->rep_by)->fullname); ?> <span>·</span> <?php echo e(\Carbon\Carbon::parse($sub->rep_date)->format("M d,Y")); ?></h4>
                                        <p><?php echo $sub->rep_content; ?></p>
                                    </div> 
                                </div> 
                                <?php endforeach; ?>
                                <?php endif; ?>
                            </div> 
                        </div> 
                        <?php endforeach; ?>

                    </div>

                </div> 

            </div>
        </div>
    </div>
</div>
<?php $__env->stopSection(); ?>
<?php $__env->startSection('footer-bottom'); ?>
    <footer>
    <?php echo $__env->make('public.layouts.footer.footer-bottom', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>
<?php $__env->stopSection(); ?>
<?php $__env->startSection('script'); ?>

<script>
    $(document).ready(function () {
        $("textarea#txtComment").keyup(function (e) {
            $(this).height(15);
            $(this).height(this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth")));
        });

        $(".reply-comment").click(function () {
            var id = $(this).attr('id');
            $(this).after('<div class="media" id = "me' + id + '">' +
                    '<div class="media-left">' +
                    '<a href="#"> <img data-holder-rendered="true" src=<?php echo e(url(\App\Image::where("user_id", "=", Auth::user()->id)->get()->first()->path)); ?> style="width: 32px; height: 32px;" class="media-object" />' +
                    '</a>' +
                    '</div>' +
                    '<div class="media-body" style = "overflow:auto">' +
                    '<div class="text-box"> ' +
                    '<textarea style="height: 48px;" id="txtReply" placeholder="add a reply..."></textarea> ' +
                    '</div> ' +
                    '<div class = "row send-box p-lr"> ' +
                    '<input class="btn btn-primary cancelReply" type="button" id ="' + id + '" value = "Cancel"/>' +
                    '<input class="btn btn-primary submitReply" type="button" id ="' + id + '" value="Gửi bình luận" />' +
                    '</div> ' +
                    '</div>' +
                    '</div>');
            return false;
        });


        $('input#submitComment').click(function (e) {
            if ($("textarea#txtComment").val() == '')
                return;
            e.preventDefault();
            var rep = {};
            var text = $("textarea#txtComment").val();
            text = text.replace(/\r\n|\r|\n/g, "<br/>");

            rep.content = text;
            rep.idTopic = $("input#idTopic").val();
            $.ajax({
                type: "POST",
                url: "<?php echo e(url('forum/reply/store')); ?>",
                data: rep,
                dataType: 'json',
                success: function (response) {
                    $("textarea#txtComment").val("");
                    location.reload();
                }
            });
        });

        $('h4.media-heading.edit').hover(
                function () {
                    var id = $(this).attr('id');
                    $('h4.media-heading#' + id).append($("<span style= 'margin-left : 5px;' class = 'option'><a href = '#' class = 'cm-edit' id ='" + id + "'><span class='glyphicon glyphicon-edit' style='size: 15px;'></span></a><a href = '#' class ='cm-remove' id ='" + id + "'><span class='glyphicon glyphicon-remove' style='margin-left:5px;size: 15px;'></span></a></span>"));
                }, function () {
            var id = $(this).attr('id');
            $('h4.media-heading#' + id).find("span.option").remove();
        }
        );

         var textEdit = '';
        $(document).on("click", ".cm-edit", function (e) {
            e.preventDefault();
            var id = $(this).attr('id');
            var tagNext = $("h4.media-heading.edit span.option").parent().next();
            var text = tagNext.html().replace(/<br>/g, "\n");
             textEdit = text;
            tagNext.replaceWith('<div id = "' + id + '"><div class="text-box"> ' +
                    '<textarea style="height: 48px;" id="txtEdit" placeholder="add a reply...">' + text + '</textarea> ' +
                    '</div> ' +
                    '<div class = "row send-box p-lr"> ' +
                    '<input class="btn btn-primary cancelEdit" type="button" id="' + id + '"  value = "Cancel"/>' +
                    '<input class="btn btn-primary submitEdit" type="button" id ="' + id + '"  value="Cập nhật" />' +
                    '</div></div>')
            return false;
        });
    });


    $(document).on("click", ".cancelReply", function () {
        var divP = "div#me" + $(this).attr('id');
        $(divP).remove();
    });
    $(document).on("click", ".submitReply", function (e) {
        if ($("textarea#txtReply").val() == '')
            return;
        e.preventDefault();
        var rep = {};
        var text = $("textarea#txtReply").val();
        text = text.replace(/\r\n|\r|\n/g, "<br/>");
        rep.content = text;
        rep.idTopic = $("input#idTopic").val();
        rep.idParent = $(this).attr('id');
        $.ajax({
            type: "POST",
            url: "<?php echo e(url('forum/reply/store')); ?>",
            data: rep,
            dataType: 'json',
            success: function (response) {
                $("textarea#txtReply").val("");
                location.reload();
            }
        });
        
    });


    //edit comment
    //cancel comment
    $(document).on("click", ".cancelEdit", function () {
        var divP = "div#" + $(this).attr('id');
        // var text = $('textarea#txtEdit').val().replace(/\r\n|\r|\n/g, "<br>");
          var text = textEdit.replace(/\r\n|\r|\n/g, "<br/>");
        $(divP).replaceWith("<p>" + text + "</p>");
    });
    //changecomment
    $(document).on("click", ".submitEdit", function (e) {
        if ($("textarea#txtEdit").val() == '')
            return;
        e.preventDefault();
        var rep = {};
        var text = $("textarea#txtEdit").val();
        text = text.replace(/\r\n|\r|\n/g, "<br/>");
        rep.content = text;
        rep.idComment = $(this).attr('id').substr(4);
        $.ajax({
            type: "POST",
            url: "<?php echo e(url('forum/reply/store')); ?>",
            data: rep,
            dataType: 'json',
            success: function (response) {
                text = response.message;
            }
        });
        var divP = "div#" + $(this).attr('id');
        $(divP).replaceWith("<p>" + text + "</p>");
    });


    $(document).on("click", ".cm-remove", function (e) {
        e.preventDefault();
        var rep = {};
        rep.idComment = $(this).attr('id').substr(3);
        $.ajax({
            type: "POST",
            url: "<?php echo e(url('forum/reply/store')); ?>",
            data: rep,
            dataType: 'json',
            success: function (response) {
                location.reload();
            }
        });

    });

    $(document).on("keyup", "textarea", function (e) {
        $(this).height(15);
        $(this).height(this.scrollHeight + parseFloat($(this).css("borderTopWidth")) + parseFloat($(this).css("borderBottomWidth")));

    });



</script>
<?php $__env->stopSection(); ?>


<?php echo $__env->make('public.layouts.app', array_except(get_defined_vars(), array('__data', '__path')))->render(); ?>